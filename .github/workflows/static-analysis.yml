name: Static Analysis

on: [pull_request]

jobs:
  coverage:
    name: Unit Test, Coverage & SonarCloud
    if: github.event.pull_request.state == 'open'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (dev)
        uses: actions/checkout@v2
        with:
          # For sonar-scanner to work properly we can't use a shallow fetch
          fetch-depth: 0
      - name: Use Node.js 
        uses: actions/setup-node@v1
        with:
          node-version: 10.16
      - name: npm install, build
        run: |
          npm install
          npm build
      - name: Run unit tests
        shell: bash
        run: TEST_RUN=yes ts-mocha --recursive --require source-map-support/register './sources/**/*.spec.ts' --timeout 60000
      - name: SonarCloud scan
        # uses: sonarsource/sonarcloud-github-action@dev
        env:
          SONARCLOUD_TOKEN: ${{ secrets.SONARCLOUD_TOKEN }}
        run: |
          echo "---Installing sonar-scanner---"
          export SONAR_SCANNER_VERSION=4.2.0.1873
          export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux
          curl --create-dirs -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux.zip
          unzip -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
          export PATH=$SONAR_SCANNER_HOME/bin:$PATH
          export SONAR_SCANNER_OPTS="-server"
          echo "---Run tests with coverage---"
          TEST_RUN=yes nyc --reporter=lcov --reporter=cobertura --report-dir=coverage-reports/ ts-mocha --recursive --require source-map-support/register './sources/**/*.spec.ts' --timeout 60000
          echo "---Run sonar-scanner---"
          sonar-scanner -Dsonar.login="$SONARCLOUD_TOKEN"